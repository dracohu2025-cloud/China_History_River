server {
    listen 80;
    server_name history.aigc.green;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    server_name history.aigc.green;

    ssl_certificate /etc/letsencrypt/live/history.aigc.green/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/history.aigc.green/privkey.pem;

    root /home/ubuntu/history_river/history_river/dist;
    index index.html;

    # 由于IPv6连接问题，暂时禁用Django Admin
    # 将原 /admin (React) 移动到 /react-admin
    # Django Admin 将在IPv6问题解决后启用

    # 临时：所有访问/admin的请求重定向到/react-admin
    location = /admin {
        return 302 /react-admin/;
    }
    location ^~ /admin/ {
        return 302 /react-admin$request_uri;
    }

    # React Admin (移动到 /react-admin)
    location ^~ /react-admin/ {
        alias /home/ubuntu/history_river/history_river/dist/admin/;
        index index.html;
        try_files $uri $uri/ /admin/index.html =404;
    }
    location = /react-admin { return 302 /react-admin/; }

    # Django Admin (等待IPv6解决后启用)
    # location = /admin {
    #     proxy_pass http://127.0.0.1:8000/admin/;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    # }
    # location ^~ /admin/ {
    #     proxy_pass http://127.0.0.1:8000;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    #     proxy_set_header X-Forwarded-Prefix /admin;
    # }

    # Django Admin静态文件 (等待IPv6解决后启用)
    # location ^~ /static/ {
    #     alias /home/ubuntu/history_river/history_river/dj_backend/staticfiles/;
    #     expires 30d;
    #     add_header Cache-Control "public, immutable";
    # }

    # Django REST API (可以先启用)
    location ^~ /api/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location = /player { try_files /player.html =404; }

    location / {
        try_files $uri $uri/ /index.html;
    }

    # Express API
    location /api {
        proxy_pass http://127.0.0.1:4000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /health { proxy_pass http://127.0.0.1:4000/health; }

    # 旧的static文件（用于旧项目向后兼容）
    location /static/ { alias /home/ubuntu/admin_site/static/; }
}
